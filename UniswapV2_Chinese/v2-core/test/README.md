# Uniswap V2 合约测试

`uniswapV2/core/test` 目录包含了 Uniswap V2 协议核心智能合约的详尽测试套件，使用 **JavaScript** 和 **Waffle** 测试框架编写。这些测试文件确保了协议的每一个关键组件在部署到链上前都是安全、可靠且功能完整的。

---

## 文件功能与测试重点

### `UniswapV2Factory.spec.ts`

该文件是工厂合约的测试核心，重点关注交易对的创建和协议的权限管理。

* **初始化状态验证**: 测试用例首先断言了合约的初始状态，例如 `feeTo` 初始为零地址（`AddressZero`），`feeToSetter` 为合约部署者地址，以及 `allPairsLength` 为 0。这确保了合约的初始配置是安全的。
* **`createPair` 功能**: 这是工厂合约最重要的功能。测试用例不仅验证了成功创建交易对后会触发 `PairCreated` 事件，而且会检查事件参数的正确性，包括 `tokenA`、`tokenB`、新创建的 `pairAddress` 和当前的 `allPairsLength`。
* **地址可预测性**: 测试代码利用了 `create2` 函数的特性，在链下本地计算出交易对的地址，并与合约实际创建的地址进行比对。这验证了 Uniswap V2 交易对地址的**可预测性**，一个非常重要的设计特性。
* **错误处理**: 测试了重复创建相同或反向交易对时，合约会正确回退（`revert`），并附带 `UniswapV2: PAIR_EXISTS` 错误信息，确保了协议的逻辑严谨性。
* **权限管理**: 验证了 `setFeeTo` 和 `setFeeToSetter` 方法。测试断言只有当前的 `feeToSetter` 才能修改手续费地址或更换权限者，其他地址调用都会被拒绝并回退 `UniswapV2: FORBIDDEN` 错误。

### `UniswapV2Pair.spec.ts`

该文件深入测试了交易对合约（流动性池）的核心功能和内部逻辑。

* **流动性管理**:
    * **`mint` (添加流动性)**: 测试用例模拟了用户存入两种代币到交易对中，然后调用 `mint` 方法。它验证了 LP 代币的铸造数量是否正确，`totalSupply` 是否按预期增加，以及 `token0` 和 `token1` 的储备量（`reserve`）是否与实际余额同步。
    * **`burn` (移除流动性)**: 测试模拟了用户销毁 LP 代币以移除流动性。它验证了两种代币的返还数量是否与销毁的 LP 代币成比例，并且在移除后 `totalSupply` 和储备量是否正确更新。
* **`swap` (代币兑换)**: 测试了 `swap` 功能，包括在交易池中兑换代币时的输入/输出量计算。它不仅验证了转账的正确性，还检查了交易完成后，交易池的储备量是否仍然满足 **k 恒定乘积公式** (`x * y = k`)。
* **Gas 消耗与事件**: 测试用例通过检查交易收据中的 `gasUsed` 字段，来验证某些关键操作（如 `createPair`）的 Gas 成本，确保其高效性。同时，每一个关键操作（`mint`, `burn`, `swap`, `sync`）都会验证其是否正确触发了相应的事件。
* **手续费机制**: 测试用例验证了当 `feeTo` 地址被设置后，交易对在流动性增长时是否会正确地向该地址铸造额外的 LP 代币作为手续费。这确保了协议收入机制的有效性。

### `UniswapV2ERC20.spec.ts`

该文件测试了作为 LP 代币的 ERC20 合约，并特别关注了 `permit` 功能。

* **ERC20 标准**: 测试涵盖了所有标准的 ERC20 方法，如 `name`、`symbol`、`totalSupply`、`balanceOf`、`approve` 和 `transferFrom`，确保了 LP 代币符合行业标准。
* **链下签名 ( `permit` )**: 这是测试的重点之一。它模拟了用户在链下使用私钥对授权进行签名，然后将签名参数 (`v`, `r`, `s`) 传入链上的 `permit` 函数。测试用例验证了 `permit` 函数能够通过 `ecrecover` 成功恢复出签名者的地址，从而证明签名的有效性，并完成授权。这个过程确保了用户无需支付 Gas 就能进行授权操作。

### `fixtures.ts` 和 `utilities.ts`

这两个文件为测试套件提供了支持。

* **`fixtures.ts`**: 包含了可重用的测试夹具（fixtures），如 `factoryFixture` 和 `pairFixture`。它们抽象了合约部署的复杂性，使得每个测试用例都能在一个一致、干净的状态下开始，极大地提高了测试效率和可读性。
* **`utilities.ts`**: 提供了各种辅助函数，如 `getCreate2Address` 和 `getApprovalDigest`。这些函数处理了复杂的链下计算，使得主测试文件中的逻辑更加简洁，易于理解。

---

## 总体结论

Uniswap V2 的测试套件是智能合约测试领域的典范。它不仅全面覆盖了合约的每个公共方法，还通过**模拟真实的交互流程**、**验证事件触发**、**检查 Gas 消耗**和**深入测试关键设计特性**（如 `create2` 地址和链下签名）来确保协议的健壮性。这种系统性的测试方法是保证去中心化金融（DeFi）协议安全和可靠性的基石。
